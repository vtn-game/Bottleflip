# 直立判定機能

## 機能ID
`MAIN-FUNC-005`

## 概要
ボトルが「直立している」と判定するためのロジック設計。
ボトルフリップ成功判定の中核となる機能。

## 設計の目的
オブジェクト（ボトル）がテーブル上で「立っている」状態を正確に判定し、
ゲームとして納得感のある成否判定を実現する。

---

## 直立の定義

### 幾何学的定義
「直立」とは、オブジェクトの上方向ベクトル（`transform.up`）が
ワールド空間の上方向ベクトル（`Vector3.up`）と十分に近い状態を指す。

```
     Vector3.up (0, 1, 0)
         ↑
         │
         │  θ = 傾き角度
         │ ╱
         │╱
    ────┼────
        │
   transform.up
```

### 判定条件

| 条件 | 説明 | パラメータ |
|------|------|------------|
| 傾き角度 | `transform.up`と`Vector3.up`の角度差 | 15度以内 |
| 接地状態 | 地面/テーブルに接触している | レイキャスト判定 |
| 速度安定 | 移動速度が十分に小さい | 0.1 m/s以下 |
| 回転安定 | 回転速度が十分に小さい | 0.1 rad/s以下 |
| 継続時間 | 上記条件の継続 | 0.5秒以上 |

---

## 傾き角度の計算

### 計算方法
Unity の `Vector3.Angle()` を使用して、2つのベクトル間の角度を算出する。

```csharp
// 直立判定
float angle = Vector3.Angle(bottle.transform.up, Vector3.up);
bool isUpright = angle <= UPRIGHT_THRESHOLD;
```

### なぜ `transform.up` を使用するか

1. **ボトルの上方向を表現**
   - ボトルのローカルY軸（上方向）がワールドのY軸と一致していれば直立
   - モデルの向きに依存せず、プレハブ設定で正規化可能

2. **Quaternion計算の簡略化**
   - `Quaternion.Euler`や分解計算より直感的で高速
   - ジンバルロックの問題を回避

3. **視覚的な一致**
   - プレイヤーが「立っている」と感じる状態と一致する

### しきい値の根拠（15度）

| 角度 | 視覚的印象 | 判定 |
|------|-----------|------|
| 0-5度 | 完全に直立 | 成功 |
| 5-15度 | 少し傾いているが立っている | 成功 |
| 15-30度 | 傾いているが踏ん張っている | 失敗 |
| 30-90度 | 明らかに倒れかけ | 失敗 |

- 15度はゲームとして「成功と感じられる」上限
- これ以上緩くすると納得感が低下
- これ以下だと成功難易度が高すぎる

---

## 接地判定

### レイキャスト方式

```csharp
bool IsGrounded()
{
    // ボトル中心から下方向にレイを飛ばす
    Vector3 origin = bottle.transform.position;
    float rayLength = collider.bounds.extents.y + 0.1f;

    return Physics.Raycast(origin, Vector3.down, rayLength);
}
```

### 判定ポイント
- ボトル中心からの単一レイで十分（底面全体の接触は不要）
- レイ長さ = コライダーの高さの半分 + マージン（0.1m）
- テーブルと床の両方を判定対象とする

### なぜ必要か
- 空中で偶然直立した状態を除外
- 着地前の一瞬の姿勢を成功と誤判定しない

---

## 速度安定判定

### 移動速度と回転速度

```csharp
bool IsStable()
{
    bool velocityStable = rigidbody.velocity.magnitude < VELOCITY_THRESHOLD;
    bool angularStable = rigidbody.angularVelocity.magnitude < VELOCITY_THRESHOLD;
    return velocityStable && angularStable;
}
```

### しきい値の根拠（0.1 m/s, 0.1 rad/s）

| 速度 | 状態 |
|------|------|
| 0.0 | 完全停止 |
| 0.01-0.05 | 微振動（物理演算の誤差レベル） |
| 0.05-0.1 | ゆっくり動いている（判定ギリギリ） |
| 0.1以上 | 明らかに動いている |

- 0.1は物理演算の安定状態を示す実用的な値
- 完全停止（0.0）を待つとゲームテンポが悪化

---

## 継続時間判定

### なぜ必要か
- 偶然の一瞬だけ条件を満たした場合を除外
- 「ちゃんと立った」という納得感を担保

### 実装方針

```csharp
float stableStartTime = 0;
bool wasStable = false;

void UpdateJudge()
{
    if (IsUpright() && IsStable() && IsGrounded())
    {
        if (!wasStable)
        {
            stableStartTime = Time.time;
            wasStable = true;
        }

        if (Time.time - stableStartTime >= STABLE_TIME)
        {
            // 成功確定
            OnSuccess();
        }
    }
    else
    {
        wasStable = false;
    }
}
```

### しきい値の根拠（0.5秒）

| 時間 | ゲーム体験 |
|------|-----------|
| 0.1秒 | 一瞬すぎて成功感が薄い |
| 0.3秒 | やや短い、ギリギリ |
| 0.5秒 | 適切、「立った！」と感じる |
| 1.0秒 | 長い、テンポが悪い |

---

## 失敗判定

### 失敗条件

1. **倒れた状態で安定**
   - `IsStable() == true` かつ `IsUpright() == false`
   - ボトルが倒れて動かなくなった

2. **タイムアウト**
   - 判定開始から10秒経過
   - ボトルが永遠に揺れ続けるケースを防止

3. **場外落下**
   - ボトルがテーブルから落下
   - Y座標が一定以下になった（オプション）

---

## 状態遷移図

```
    ┌──────────────────────────────────────────────┐
    │                                              │
    ▼                                              │
 ┌──────┐    着地      ┌─────────┐   条件満たす   ┌────────────┐
 │Flying│──────────▶  │ Landed  │─────────────▶ │Stabilizing │
 └──────┘             └─────────┘               └────────────┘
    │                                               │      │
    │                                        0.5秒継続   条件外れる
    │                                               │      │
    │                                               ▼      │
    │                                           ┌───────┐  │
    │                                           │Success│  │
    │                                           └───────┘  │
    │                                                      │
    │   倒れて安定 / タイムアウト                            │
    │◀─────────────────────────────────────────────────────┘
    │
    ▼
 ┌──────┐
 │Failed│
 └──────┘
```

---

## パフォーマンス考慮

### 更新頻度
- `FixedUpdate` で判定（物理演算と同期）
- 毎フレーム判定はコスト許容範囲内

### 最適化
- レイキャストは1本のみ
- Vector演算は軽量
- 判定中以外は処理しない

---

## デバッグ支援

### Gizmos表示
- 傾き角度を円弧で表示
- レイキャストを線で表示
- 成功時は緑、失敗時は赤

### ログ出力
- 判定開始・終了時
- 条件変化時（安定開始、傾き閾値超過等）

---

## 関連ファイル

- `BottleFlipController.cs`: 直立判定の実装
- `spec/rule/gamerule.md`: ゲームルールにおける成功条件

## 参照

- 機能仕様 `MAIN-FUNC-001`: ボトルフリップ物理機能
