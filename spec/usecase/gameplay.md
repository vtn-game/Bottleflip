# ゲームプレイ中に期待される振る舞い

## Feature: ボトルを投げる

### Scenario: 正常な投げ処理
  Given プレイヤーがサーバーに接続している
  And オーバーレイ画面が開いていない
  When スマホを振る（加速度がしきい値を超える）
  Then 投げイベントがサーバーに送信される
  And 母艦アプリでボトルが生成される
  And ボトルに初速と回転が適用される
  And 判定処理が開始される

### Scenario: 接続切断時の投げ
  Given プレイヤーがサーバーに接続していない
  When スマホを振る
  Then エラーメッセージが表示される
  And 投げイベントは送信されない

### Scenario: オーバーレイ画面表示中の投げ
  Given ガチャ画面またはボトル選択画面が開いている
  When スマホを振る
  Then 投げ処理は実行されない


## Feature: 成功判定

### Scenario: ボトルが立った場合
  Given ボトルが地面に接触している
  And ボトルの傾きが15度以内
  And ボトルの速度がしきい値以下
  When 安定状態が0.5秒以上継続する
  Then 成功と判定される
  And 結果イベントがWebアプリに送信される
  And コインが加算される

### Scenario: ボトルが倒れた場合
  Given ボトルが地面に接触している
  And ボトルの速度がしきい値以下
  When ボトルの傾きが15度を超えている
  Then 失敗と判定される
  And 結果イベントがWebアプリに送信される

### Scenario: 判定タイムアウト
  Given ボトルが投げられた
  When 10秒経過しても判定が確定しない
  Then 失敗と判定される


## Feature: コメント投稿

### Scenario: コメントを送信する
  Given 投げ結果が表示されている
  And コメント入力欄にテキストがある
  When 送信ボタンを押す
  Then コメントがサーバーに送信される
  And 母艦アプリにコメントが表示される
  And コメント画面が閉じる
  And メイン画面に戻る

### Scenario: コメントをスキップする
  Given 投げ結果が表示されている
  When スキップボタンを押す
  Then コメントは送信されない
  And コメント画面が閉じる
  And メイン画面に戻る


## Feature: iOS パーミッション対応

### Scenario: パーミッションが必要な場合
  Given iOS 13以上のデバイスである
  And 加速度センサーの許可がされていない
  When アプリを起動する
  Then パーミッション許可パネルが表示される

### Scenario: パーミッションを許可する
  Given パーミッション許可パネルが表示されている
  When 許可ボタンを押す
  Then DeviceMotionAPIの許可リクエストが発行される
  And 許可された場合、振り検知が有効になる
  And パーミッションパネルが閉じる

### Scenario: パーミッションを拒否された
  Given パーミッション許可リクエストを発行した
  When ユーザーが拒否した
  Then エラーメッセージが表示される
  And 振り検知は無効のまま
